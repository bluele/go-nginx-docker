machine:
  services:
    - docker
  timezone:
    Asia/Tokyo

dependencies:
  override:
    - sudo pip install --upgrade docker-compose==1.3.0

test:
  pre:
    - docker-compose build
  override:
    - docker-compose up unittest

deployment:
  staging:
    branch: master
    commands:
      - docker-compose up build
      - go get github.com/aktau/github-release
      - github-release release --user bluele --repo go-nginx-docker --tag st-`cat release_tag` --name "go-nginx-docker st-`cat release_tag`" --description "sample"
      - github-release upload --user bluele --repo go-nginx-docker --tag st-`cat release_tag` --name app_linux_amd64 --file ./dist/app_linux_amd64

  release:
    branch: release
    commands:
      - docker-compose up build
      - go get github.com/aktau/github-release
      - github-release release --user bluele --repo go-nginx-docker --tag `cat release_tag` --name "go-nginx-docker `cat release_tag`" --description "sample"
      - github-release upload --user bluele --repo go-nginx-docker --tag `cat release_tag` --name app_linux_amd64 --file ./dist/app_linux_amd64
